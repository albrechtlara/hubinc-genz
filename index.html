<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUB.INC GENZ - Intelligence</title>
    <!-- Bibliotecas de suporte -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: black; color: white; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select, textarea { font-size: 16px !important; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDA7wTYuqA7O5jvFTlneKv044yly7gth90",
            authDomain: "hubinc-genz.firebaseapp.com",
            projectId: "hubinc-genz",
            storageBucket: "hubinc-genz.firebasestorage.app",
            messagingSenderId: "513814569601",
            appId: "1:513814569601:web:d39203b41f6b4dced92380",
            measurementId: "G-D03RK7D08V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'hubinc-genz';

        window.fbRefs = { db, auth, collection, onSnapshot, addDoc, deleteDoc, signInAnonymously, onAuthStateChanged, appId };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const INITIAL_DATA = [
            { "Macroterritório": "Aguardando Dados", "Tipo": "Info", "Pain/Passion Point": "Nenhum dado encontrado no Firebase. Por favor, use o botão importar.", "Direcional Estratégico (Oportunidade para marcas)": "O seu banco de dados oficial está vazio.", "Menções": 1 }
        ];

        const MandalaGalaxy = ({ categories, onSelect }) => (
            <div className="grid grid-cols-2 gap-4 animate-in fade-in duration-700">
                {categories.map((cat, idx) => {
                    const maxMentions = Math.max(...categories.map(c => c.total), 1);
                    const scale = 0.85 + (cat.total / maxMentions) * 0.25;
                    return (
                        <button key={idx} onClick={() => onSelect(cat.name)} style={{ transform: `scale(${scale})` }}
                            className="relative aspect-square bg-zinc-900 border border-white/5 rounded-[3rem] p-6 flex flex-col justify-end overflow-hidden active:scale-95 transition-all shadow-2xl group">
                            <div className="absolute -top-10 -left-10 w-32 h-32 bg-purple-600/10 rounded-full blur-3xl group-hover:bg-purple-600/20 transition-colors" />
                            <div className="relative z-10 text-left">
                                <span className="text-[9px] font-black text-purple-400 uppercase block mb-1">
                                    {Number(cat.total).toLocaleString()} CAPTADAS
                                </span>
                                <h4 className="text-sm font-black text-white leading-tight uppercase italic break-words tracking-tighter">{cat.name}</h4>
                            </div>
                        </button>
                    );
                })}
            </div>
        );

        function App() {
            const [selectedMacro, setSelectedMacro] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isAuthModalOpen, setIsAuthModalOpen] = useState(false);
            const [importProgress, setImportProgress] = useState({ active: false, current: 0, total: 0, error: null });
            const [hubData, setHubData] = useState({ mandala: INITIAL_DATA });
            const [password, setPassword] = useState("");
            const fileInputRef = useRef(null);

            useEffect(() => {
                const initFirebase = setInterval(() => {
                    if (window.fbRefs) {
                        clearInterval(initFirebase);
                        const { auth, db, appId, onSnapshot, collection, signInAnonymously } = window.fbRefs;
                        signInAnonymously(auth).catch(err => console.error("Erro Auth:", err));
                        const colPath = collection(db, 'artifacts', appId, 'public', 'data', 'mandala');
                        onSnapshot(colPath, (snap) => {
                            if (!snap.empty) {
                                setHubData({ mandala: snap.docs.map(d => ({ id: d.id, ...d.data() })) });
                            }
                        }, (err) => {
                            console.error("Erro ao ler dados:", err);
                        });
                    }
                }, 500);
                return () => clearInterval(initFirebase);
            }, []);

            const categories = useMemo(() => {
                const agg = hubData.mandala.reduce((acc, curr) => {
                    const macro = curr.Macroterritório || "Outros";
                    const mentions = Number(curr.Menções || 0);
                    if (!acc[macro]) acc[macro] = { name: macro, total: 0, items: [] };
                    acc[macro].total += mentions;
                    acc[macro].items.push(curr);
                    return acc;
                }, {});
                return Object.values(agg).sort((a, b) => b.total - a.total);
            }, [hubData.mandala]);

            const handleCSVImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                    
                    // Detetar se o separador é vírgula ou ponto e vírgula
                    const firstLine = lines[0];
                    const separator = firstLine.includes(';') ? ';' : ',';
                    
                    const parseLine = l => {
                        const r = []; let c = '', q = false;
                        for (let i = 0; i < l.length; i++) {
                            if (l[i] === '"') q = !q;
                            else if (l[i] === separator && !q) { r.push(c.trim()); c = ''; }
                            else c += l[i];
                        }
                        r.push(c.trim()); return r;
                    };

                    const headers = parseLine(lines[0]).map(h => h.replace(/^"|"$/g, ''));
                    const rows = lines.slice(1);
                    setImportProgress({ active: true, current: 0, total: rows.length, error: null });
                    
                    const { db, appId, collection, addDoc } = window.fbRefs;

                    try {
                        for (let i = 0; i < rows.length; i++) {
                            const vals = parseLine(rows[i]);
                            const entry = {};
                            headers.forEach((h, idx) => {
                                let val = vals[idx] ? vals[idx].replace(/^"|"$/g, '') : '';
                                if (h === 'Menções') val = Number(String(val).replace(/\D/g, '')) || 0;
                                entry[h] = val;
                            });

                            if (entry['Macroterritório']) {
                                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mandala'), { 
                                    ...entry, 
                                    updatedAt: new Date().toISOString() 
                                });
                            }
                            setImportProgress(prev => ({ ...prev, current: i + 1 }));
                        }
                        setImportProgress({ active: false, current: 0, total: 0, error: null });
                        alert("Sincronização concluída!");
                    } catch (err) {
                        setImportProgress(prev => ({ ...prev, error: "Erro de Permissão no Firebase. Verifique as 'Rules'." }));
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="min-h-screen pb-40">
                    <header className="p-6 flex justify-between items-center border-b border-white/5 sticky top-0 bg-black/80 backdrop-blur-xl z-50">
                        <div>
                            <span className="text-[9px] font-black text-purple-500 uppercase tracking-widest block mb-0.5">Consumer Intel</span>
                            <h1 className="text-2xl font-black italic uppercase tracking-tighter leading-none">HUB.INC GENZ</h1>
                        </div>
                        <button onClick={() => isAdmin ? setIsAdmin(false) : setIsAuthModalOpen(true)} 
                                className={`w-12 h-12 rounded-2xl border flex items-center justify-center transition-all ${isAdmin ? 'bg-purple-600 border-purple-400 shadow-lg' : 'bg-white/5 border-white/10'}`}>
                           <span className="text-lg">⚙️</span>
                        </button>
                    </header>

                    <main className="p-6 max-w-lg mx-auto">
                        <div className="flex justify-between items-center mb-10 h-10">
                            <button onClick={() => setSelectedMacro(null)} className={`text-white/40 text-[10px] font-black uppercase tracking-widest transition-all ${selectedMacro ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                                ← Voltar
                            </button>
                            {isAdmin && !selectedMacro && (
                                <div className="flex gap-2">
                                    <input type="file" ref={fileInputRef} className="hidden" accept=".csv" onChange={handleCSVImport} />
                                    <button onClick={() => fileInputRef.current?.click()} className="px-5 py-3 bg-zinc-800 border border-white/10 rounded-full font-black text-[10px] uppercase shadow-xl active:scale-95 transition-all">
                                        Importar CSV
                                    </button>
                                </div>
                            )}
                        </div>

                        {!selectedMacro ? (
                            <div className="text-center animate-in fade-in slide-in-from-bottom-5">
                                <h2 className="text-5xl font-black italic tracking-tighter uppercase mb-2">MANDALA</h2>
                                <p className="text-white/30 text-[9px] font-black uppercase tracking-[0.4em] mb-12">Deep Intelligence</p>
                                <MandalaGalaxy categories={categories} onSelect={setSelectedMacro} />
                            </div>
                        ) : (
                            <div className="space-y-8 animate-in slide-in-from-right-5">
                                <h3 className="text-3xl font-black uppercase italic text-white mb-8 border-l-4 border-purple-500 pl-4">{selectedMacro}</h3>
                                {categories.find(c => c.name === selectedMacro).items.map((item, i) => (
                                    <div key={i} className="bg-zinc-900/60 border border-white/5 rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden">
                                        <div className="flex justify-between items-start mb-6">
                                            <span className={`text-[9px] font-black uppercase px-3 py-1 rounded-full border ${item.Tipo === 'Pain' ? 'bg-red-500/10 text-red-400 border-red-500/20' : 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20'}`}>{item.Tipo}</span>
                                            <div className="text-right">
                                                <span className="text-[9px] font-black text-white/20 uppercase block mb-1">Menções captadas</span>
                                                <span className="text-xl font-black italic text-purple-500 leading-none">{Number(item.Menções || 0).toLocaleString()}</span>
                                            </div>
                                        </div>
                                        <p className="text-xl font-medium italic mb-10 leading-tight text-white/90">"{item['Pain/Passion Point']}"</p>
                                        <div className="p-7 bg-gradient-to-br from-purple-600 to-indigo-800 rounded-[2.2rem] shadow-xl">
                                            <span className="text-[9px] font-black uppercase tracking-widest text-white/60 mb-2 block italic">Direcional Estratégico</span>
                                            <p className="text-sm font-black uppercase italic leading-snug">{item['Direcional Estratégico (Oportunidade para marcas)']}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {importProgress.active && (
                        <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex flex-col items-center justify-center p-10 text-center animate-in fade-in">
                            {importProgress.error ? (
                                <div className="space-y-6">
                                    <div className="text-red-500 text-5xl">⚠️</div>
                                    <h4 className="text-xl font-black uppercase text-red-400">{importProgress.error}</h4>
                                    <button onClick={() => setImportProgress({active:false, current:0, total:0, error:null})} className="px-8 py-4 bg-white text-black font-black rounded-full uppercase text-xs">Tentar Novamente</button>
                                </div>
                            ) : (
                                <>
                                    <div className="w-16 h-16 border-4 border-purple-500/20 border-t-purple-500 rounded-full animate-spin mb-6"></div>
                                    <h4 className="text-xl font-black italic uppercase tracking-tighter mb-2 text-white">Sincronizando Insights</h4>
                                    <p className="text-white/40 text-[10px] font-black uppercase tracking-widest">{importProgress.current} de {importProgress.total} linhas enviadas</p>
                                </>
                            )}
                        </div>
                    )}

                    {isAuthModalOpen && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-8 backdrop-blur-2xl">
                            <div className="w-full max-w-sm bg-zinc-900 border border-white/10 p-10 rounded-[3.5rem] text-center shadow-2xl relative">
                                <h3 className="text-2xl font-black uppercase mb-8 italic text-white">Admin Access</h3>
                                <input type="password" placeholder="SENHA" className="w-full bg-black border border-white/10 p-6 rounded-[2rem] text-white outline-none mb-6 text-center font-mono tracking-widest focus:border-purple-500 transition-all" onChange={e => setPassword(e.target.value)} />
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => { if(password === "GENZ2024") { setIsAdmin(true); setIsAuthModalOpen(false); } else { alert("Senha Incorreta"); } }} 
                                            className="w-full py-6 bg-purple-600 rounded-[2rem] font-black uppercase text-xs tracking-widest active:scale-95 transition-all text-white">Desbloquear</button>
                                    <button onClick={() => setIsAuthModalOpen(false)} className="py-4 text-white/20 uppercase text-[9px] font-black tracking-widest">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
